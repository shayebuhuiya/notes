## 一、设备管理

### 1、设备控制器

为了屏蔽设备之间的差异，每个设备都有一个叫**设备控制器（Device Control）** 的组件。**CPU是通过设备控制器和设备打交道**。

控制器有三类寄存器：

- 数据寄存器，CPU 向 I/O 设备写入需要传输的数据。
- 命令寄存器，CPU 发送一个命令，告诉 I/O 设备，要进行输入/输出操作，于是就会交给 I/O 设备去工作，任务完成后，会把状态寄存器里面的状态标记为完成。
- 状态寄存器，目的是告诉 CPU ，现在已经在工作或工作已经完成，如果已经在工作状态，CPU 再发送数据或者命令过来，都是没有用的，直到前面的工作已经完成，状态寄存标记成已完成，CPU 才能发送下一个字符和命令。

#### 1.1、块设备、字符设备

- 块设备，把数据存储在固定大小的块中，每个块有自己的地址，硬盘、USB 是常见的块设备。
- 字符设备，以字符为单位发送或接收一个字符流，字符设备是不可寻址的，也没有任何寻道操作，鼠标是常见的字符设备。

##### 1.1.1、块设备的数据缓冲区

块设备通常传输的数据量会非常大，于是控制器设立了一个可读写的**数据缓冲区**，可以减少对设备的频繁操作。

- CPU 写入数据到控制器的缓冲区时，当缓冲区的数据囤够了一部分，才会发给设备。
- CPU 从控制器的缓冲区读取数据时，也需要缓冲区囤够了一部分，才拷贝到内存。

#### 1.2、CPU与设备的控制寄存器、数据缓冲区通信的方式

- 端口I/O。每个指令寄存器被分配一个I/O端口，可以通过特殊的汇编指令操作寄存器。
- 内存映射I/O。将所有的控制寄存器映射到内存空间中，可以像读写内存一样读写数据缓冲区。

### 2、I/O控制方式

设备控制器读取设备的数据，读完的时候怎么通知CPU？

- 轮询等待。让CPU一直查寄存器的状态，直到状态标记为完成。这会**占据CPU的全部时间**。

- 中断。设备完成任务后触发中断到中断控制器，中断控制器通知CPU，CPU停下当前手里的事情处理中断。触发中断的方式有两种：软中断，代码调用 `INT` 指令触发；硬件中断，硬件通过中断控制器触发。但是频发触发中断，会**占用大量CPU的时间**。

- DMA（Direct Memory Access）功能，使得设备在CPU不参与的情况下，能够自行完成设备I/O并把数据放入到内存，**需要DMA控制器硬件的支持**。

#### 2.1、DMA的工作方式

1. CPU 对 **DMA 控制器**下发指令，通知读取的数据量，读完的数据放在内存的位置。
2. DMA 控制器向**磁盘控制器**发出指令，通知它从磁盘读数据到其内部的缓冲区中。
3. 磁盘控制器将缓冲区的数据传输到**内存**；
4. 磁盘控制器在**总线**上发出一个确认**成功的信号到 DMA 控制器**；
5. DMA 控制器收到信号后，DMA 控制器**发中断通知 CPU 指令完成**，CPU 就可以直接用内存里面现成的数据了；

CPU读取磁盘数据时，只需要给DMA控制器发送指令，然后返回做其他事情。磁盘数据拷贝到内存后，DMA控制机通过中断的方式，告诉CPU数据已经准备好了，CPU就会从内存读取数据，**仅仅在开始和结束需要CPU干预**。

### 3、设备驱动程序

设备控制器屏蔽了设备的区别，但是不同控制器的寄存器、缓冲区使用模式不同，为了屏蔽设备控制器的差异，引入设备驱动程序。**设备驱动程序会提供统一的接口给操作系统**。设备控制器是硬件，设备驱动程序是操作系统的一部分。

通常，设备驱动程序初始化的时候，要先**注册一个该设备的中断处理函数**。设备驱动程序中会响应设备完成后发出的中断。

### 4、通用块层

为了减少不同块设备的差异带来的影响，Linux 在**文件系统和磁盘驱动中间**加入一个统一的**通用块层**，来管理不同的块设备。有两个功能：

- **提供标准接口**。向上为文件系统和应用程序，提供访问块设备的标准接口，向下把各种不同的磁盘设备抽象为统一的块设备，并在内核层面，提供一个框架来管理这些设备的驱动程序；
- **I/O 调度**。通用层还会给文件系统和应用程序发来的 I/O 请求排队，接着会对队列重新排序、请求合并等方式，也就是 I/O 调度，主要目的是为了**提高磁盘读写的效率**。

### 5、存储系统I/O软件分层

Linux存储系统的I/O 由上到下可以分为三个层次：

- **文件系统层**，包括虚拟文件系统和其他文件系统的具体实现，它向上为应用程序统一提供了标准的文件访问接口，向下会通过通用块层来存储和管理磁盘数据。
- **通用块层**，包括块设备的 I/O 队列和 I/O 调度器，它会对文件系统的 I/O 请求进行排队，再通过 I/O 调度器，选择一个 I/O 发给下一层的设备层。
- **设备层**，包括硬件设备、设备控制器和驱动程序，负责最终物理设备的 I/O 操作。

存储系统的I/O是整个系统最慢的环节，Linux提供了缓存机制提高I/O效率：

- 为了提高文件访问的效率，会使用**页缓存（Linux 的 page cache）、索引节点缓存、目录项缓存**等多种缓存机制，目的是为了减少对块设备的直接调用。
- 为了提高块设备的访问效率， 会使用**缓冲区**（Linux 的 buffer cache），来缓存块设备的数据。

### 6、键盘敲入字母期间发生了什么？

1. 用户输入字符，**键盘控制器**会产生**扫描码数据**，将其缓冲在键盘控制器的**寄存器**中。键盘控制器通过总线**给CPU发送中断请求**。

2. CPU收到中断请求后，操作系统会保存中断进程的**CPU上下文**，调用键盘的**中断处理程序**。

   中断处理程序在键盘驱动程序初始化时注册的。这个中断程序会从键盘控制器的寄存器的缓冲区中**读取扫描码**，根据扫描码找到用户输入的字符。

3. 如果输入的字符是显示字符，就会把扫描码翻译成对应显示字符的ASCLL码。

4. 将ASCLL码放到读缓冲区队列。**显示设备的驱动程序**定时从**读缓冲区队列**，读取数据到**写缓冲区队列**。最后把写缓冲区队列的数据一个个写入到**显示设备的控制器的寄存器**中的数据缓存区，最后将这些数据**显示在屏幕里**。

5. 显示出结果后，**恢复被中断进程的上下文**。

