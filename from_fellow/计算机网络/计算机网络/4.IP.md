## 一、IP基础

IP 在 TCP/IP 参考模型中处于第三层，也就是**网络层**。网络层的主要作用是：**实现主机与主机之间的通信，也叫点对点（end to end）通信。**IP的作用是在复杂的网络环境中将数据包发送给最终目的主机。

### 1、IP网络层、MAC数据链路层的关系

一言以蔽之， **MAC 的作用则是实现「直连」的两个设备之间通信，而 IP 则负责在「没有直连」的两个网络之间进行通信传输。** 计算机网络中也需要「数据链路层」和「网络层」这个分层才能实现向最终目标地址的通信。

在网络中数据包传输中也是如此，**源IP地址和目标IP地址在传输过程中是不会变化的（前提：没有使用 NAT 网络），只有源 MAC 地址和目标 MAC 一直在变化。** 

### 2、IP地址

IPv4 地址由 `32` 位正整数来表示，IP 地址在计算机是以二进制的方式处理的。 而人类为了方便记忆采用了**点分十进制**的标记方式 。 

**IP 地址最大值是：** <img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/5.jpg" alt="img" style="zoom:50%;" /> 使用**NAT技术**可以使得地址最大数量超过上限。

### 3、IP地址的分类

早期地址充裕，分成了A-E五类地址。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/7.jpg" alt="IP 地址分类" style="zoom:50%;" /> 

#### 3.1、A、B、C类地址

A、B、C类地址分为**网络号和主机号**两个部分。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/8.jpg" alt="img" style="zoom:50%;" /> 

##### 最大主机数的计算方式<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/9.jpg" alt="img" style="zoom:50%;" />

-2的原因是因为两个IP地址是特殊的：

- **主机号全为 1** 指定某个网络下的所有主机，用于**广播**
- **主机号全为 0** 指定**网络地址**。

> 广播地址的作用：广播地址用于在**同一个链路中相互连接的主机之间发送数据包**。 当主机号全为 1 时，就表示该网络的广播地址。 
>
> 广播地址可以分为本地广播和直接广播两种。
>
> - **在本网络内广播的叫做本地广播**。例如网络地址为 192.168.0.0/24 的情况下，广播地址是192.168.0.255 。因为这个广播地址的 IP 包会被路由器屏蔽，所以不会到达 192.168.0.0/24 以外的其他链路上。
> - **在不同网络之间的广播叫做直接广播**。例如网络地址为 192.168.0.0/24 的主机向 192.168.1.255/24 的目标地址发送 IP 包。收到这个包的路由器，将数据转发给 192.168.1.0/24，从而使得所有 192.168.1.1~192.168.1.254 的主机都能收到这个包（**由于直接广播有一定的安全问题，多数情况下会在路由器上设置为不转发**。） 。

#### 3.2、D、E类地址

而 D 类和 E 类地址是没有主机号的，所以不可用于主机 IP，D 类常被用于**多播**，E 类是预留的分类，暂时未使用。多播用于**将包发送给特定组内的所有主机。** 

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/13.jpg" alt="单播、广播、多播通信" style="zoom:50%;" /> 

#### 3.3、IP分类的优缺点

##### 3.3.1、优点：简单明了，选址简单

通过IP地址前几位判断，可以快速确认是哪类地址：第一位是0的是A类地址，第二位是0的是B类地址……

##### **3.3.2、缺点一：地址不灵活，不能划分层次**

**同一网络下没有地址层次**，比如一个公司里用了 B 类地址，但是可能需要根据生产环境、测试环境、开发环境来划分地址层次，而这种 IP 分类是没有地址层次划分的功能，所以这就**缺少地址的灵活性**。 

**3.3.3、缺点二：不能很好地与现实网络匹配**

- C 类地址能包含的最大主机数量实在太少了，只有 254 个，一个网吧都不够用。
- 而 B 类地址能包含的最大主机数量又太多了，6 万多台机器放在一个网络下面，一般的企业基本达不到这个规模，闲着的地址就是浪费。

这两个缺点，都可以在 **`CIDR` 无分类地址**解决。 

### 4、无分类地址CIDR

这种方式不再有分类地址的概念，32 比特的 IP 地址被划分为两部分，前面是**网络号**，后面是**主机号**。 表示形式：`a.b.c.d/x`，其中 `/x` 表示前 x 位属于**网络号**， x 的范围是 `0 ~ 32`，这就使得 IP 地址更加具有灵活性。 

子网掩码：**将子网掩码和 IP 地址按位计算 AND，就可得到网络号。**

#### 4.1、为什么要划分网络号、主机号

两台主机通信首先需要判断**是否在同一个广播域**内。如果是就把数据包直接发送到目标主机。如果不是就需要路由器寻址发到对应网络上。

#### 4.2、如何进行子网划分

**子网划分实际上是将主机地址分为两个部分：子网网络地址和子网主机地址**。形式如下：

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/18.jpg" alt="img" style="zoom:50%;" />

- 未做子网划分的 ip 地址：网络地址＋主机地址
- 做子网划分后的 ip 地址：网络地址＋（子网网络地址＋子网主机地址）

> 假设对 C 类地址进行子网划分，网络地址 192.168.1.0，使用子网掩码 255.255.255.192 对其进行子网划分。C 类地址中前 24 位是网络号，最后 8 位是主机号，根据子网掩码可知**从 8 位主机号中借用 2 位作为子网号**。
>
> <img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/19.jpg" alt="img" style="zoom:50%;" /> 
>
> 由于子网网络地址被划分成 2 位，那么子网地址就有 4 个，分别是 00、01、10、11 

### 5、公有IP与私有IP

在 A、B、C 分类地址，实际上有分公有 IP 地址和私有 IP 地址。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/22.jpg" alt="img" style="zoom:50%;" />

私有IP可以由组织人员自行分配。但是如果是一个所有人都能访问的网站，则必须注册一个**公有IP**。

#### 5.1、公有IP由谁管理？

私有 IP 地址通常是内部的 IT 人员管理，公有 IP 地址是由 **`ICANN` 组织**管理，中文叫**「互联网名称与数字地址分配机构」**。IANA 是 ICANN 的其中一个机构，它负责分配互联网 IP 地址，是按州的方式层层分配。

其中，在中国是由 **CNNIC** 的机构进行管理，它是中国国内唯一指定的全局 IP 地址管理的组织。

### 6、IP地址和路由控制

#### 6.1、路由表中的最长匹配原则

IP地址中网络地址这部分用于**路由控制**。如果路由控制表中存在多条相同网络地址的记录，就选**择相同位数最多的网络地址，也就是最长匹配。**

在发送 IP 包时，首先要确定 IP 包首部中的目标地址，再从路由控制表中找到与该地址具有**相同网络地址**的记录，根据该记录将 IP 包转发给相应的下一个路由器。

> <img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/25.jpg" alt="IP 地址与路由控制" style="zoom:50%;" /> 
>
> 1. 主机 A 要发送一个 IP 包，其源地址是 `10.1.1.30` 和目标地址是 `10.1.2.10`，由于没有在主机 A 的路由表找到与目标地址 `10.1.2.10` 相同的网络地址，于是包被转发到默认路由（路由器 `1` ）；
> 2. 路由器 `1` 收到 IP 包后，也在路由器 `1` 的路由表匹配与目标地址相同的网络地址记录，发现匹配到了，于是就把 IP 数据包转发到了 `10.1.0.2` 这台路由器 `2`；
> 3. 路由器 `2` 收到后，同样对比自身的路由表，发现匹配到了，于是把 IP 包从路由器 `2` 的 `10.1.2.1` 这个接口出去，最终经过交换机把 IP 数据包转发到了目标主机；
>

#### 6.2、环回地址不会流向网络

环回地址是在同一台计算机上的程序之间进行网络通信时所使用的一个默认地址。**指向的是自己的地址**。计算机使用一个特殊的 IP 地址 **127.0.0.1 作为环回地址**。与该地址具有相同意义的是一个叫做 `localhost` 的主机名。使用这个 IP 或主机名时，数据包不会流向网络。

### 7、IP分片与重组（尽量不由IP分片）

每种**数据链路的最大传输单元 `MTU`** 都是不相同的，以太网的 MTU 是 1500 字节等。

当 IP 数据包大小大于 MTU 时， IP 数据包就会被分片。经过分片之后的 IP 数据报在被重组的时候，只能由目标主机进行，**路由器是不会进行重组**的。

> 假设发送方发送一个 4000 字节的大数据报，若要传输在以太网链路，则需要把数据报分片成 3 个小数据报进行传输，再交由接收方重组成大数据报。
>
> <img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/26.jpg" alt="分片与重组" style="zoom:50%;" />

在分片传输中，**一旦某个分片丢失，则会造成整个 IP 数据报作废**，所以 TCP 引入了 **最大报文段长度`MSS`** 也就是**在 TCP 层进行分片不由 IP 层分片**，那么**对于 UDP 我们尽量不要发送一个大于 `MTU` 的数据报文**。

### 8、IPv6

IPv4 的地址是 32 位的，IPv6 的地址是 `128` 位的 。

#### 8.1、IPv6的优点-自动配置、简化首部、安全提高

- IPv6 可**自动配置**，即使没有 DHCP 服务器也可以实现自动分配IP地址。
- IPv6 包头包首部长度采用固定的值 `40` 字节，**去掉了包头校验和**，**简化了首部结构**，减轻了路由器负荷，大大**提高了传输的性能**。
- IPv6 有应对伪造 IP 地址的网络安全功能以及防止线路窃听的功能，大大**提升了安全性**。

#### 8.2、IPv6的标识方法

- IPv4 地址长度共 32 位，是以**每 8 位作为一组**，并用**点分十进制**的表示方式。


- IPv6 地址长度是 128 位，是以**每 16 位作为一组**，每组用**冒号 「:」** 隔开。

  **如果出现连续的 0 时还可以将这些 0 省略，并用两个冒号 「::」隔开。**但是，一个 IP 地址中只允许出现**一次**两个连续的冒号。 

#### 8.3、IPv4 首部与 IPv6 首部

![IPv4 首部与 IPv6 首部的差异](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/31.jpg)

IPv6 相比 IPv4 的首部改进：

- **取消了首部校验和字段。** 因为在数据链路层和传输层都会校验，因此 IPv6 直接取消了 IP 的校验。
- **取消了分片/重新组装相关字段。** 分片与重组是耗时的过程，IPv6 不允许在中间路由器进行分片与重组，这种操作只能在源与目标主机，这将大大提高了路由器转发的速度。
- **取消选项字段。** 选项字段不再是标准 IP 首部的一部分了，但它并没有消失，而是可能出现在 IPv6 首部中的「下一个首部」指出的位置上。删除该选项字段使的 IPv6 的首部成为**固定长度的 `40` 字节**。

## 二、IP协议相关技术

### 1、DNS域名解析

DNS 可以将域名网址自动转换为具体的 IP 地址。 DNS 中的域名都是用**句点**来分隔的，比如 `www.server.com`，这里的句点代表了不同层次之间的**界限**。在域名中，**越靠右**的位置表示其层级**越高**。

### 2、ARP地址解析协议

ARP通过**广播**的形式，是借助 **ARP 请求与 ARP 响应**两种类型的包确定 MAC 地址的，并且会用ARP缓存保存对应IP地址的MAC地址。

#### 2.1、RARP协议

RARP 协议正好相反，它是**已知 MAC 地址求 IP 地址**。例如将**打印机服务器等小型嵌入式设备接入到网络时**就经常会用得到。 通常这需要架设一台 `RARP` 服务器，在这个服务器上注册设备的 MAC 地址及其 IP 地址。然后再将这个设备接入到网络，接着：

- 该设备会发送一条「我的 MAC 地址是XXXX，请告诉我，我的IP地址应该是什么」的请求信息。
- RARP 服务器接到这个消息后返回「MAC地址为 XXXX 的设备，IP地址为 XXXX」的信息给这个设备。最后，设备就根据从 RARP 服务器所收到的应答信息设置自己的 IP 地址。

### 3、DHCP动态获取IP地址协议

可以省去固定分配IP地址的繁琐。DHCP 交互中，**全程都是使用 UDP 广播通信**。

#### 3.1、分配流程：发现 - 提供 - 请求 - ACK

- 客户端首先发起 **DHCP 发现报文 的 IP 数据报。**

  由于客户端没有 IP 地址，也不知道 DHCP 服务器的地址，所以使用的是 UDP **广播**通信，其使用的广播目的地址是 255.255.255.255（端口 67） 并且使用 0.0.0.0（端口 68） 作为源 IP 地址。DHCP 客户端将该 IP 数据报传递给链路层，链路层然后将帧广播到所有的网络中设备。

- DHCP 服务器收到 DHCP 发现报文时，用 **DHCP 提供报文 向客户端做出响应。**

  **该报文仍然使用 IP 广播地址 255.255.255.255，该报文信息携带服务器提供可租约的 IP 地址、子网掩码、默认网关、DNS 服务器以及 **IP 地址租用期。

- 客户端收到一个或多个服务器的 DHCP 提供报文后，从中选择一个服务器，并向选中的服务器发送 **DHCP 请求报文**进行响应。

- 最后，服务端用 **DHCP ACK 报文**对 DHCP 请求报文进行响应，应答所要求的参数。

#### 3.2、租约到期：请求-ACK

如果租约的 DHCP IP 地址快期后，客户端会向服务器发送 DHCP 请求报文：

- 服务器如果同意继续租用，则用 DHCP ACK 报文进行应答，客户端就会延长租期。
- 服务器如果不同意继续租用，则用 DHCP NACK 报文，客户端就要停止使用租约的 IP 地址。

#### 3.3、DHCP中继代理

由于使用的是广播，如果DHCP服务器和客户端不在一个局域网内，由于**路由器不会转发广播包**，这导致DHCP失效。有了 **DHCP 中继代理**以后，**对不同网段的 IP 地址分配也可以由一个 DHCP 服务器统一进行管理。** 

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/37.jpg" alt=" DHCP 中继代理" style="zoom:50%;" />

- **DHCP 客户端会向 DHCP 中继代理发送 DHCP 请求包**，而 DHCP 中继代理在收到这个广播包以后，再以**单播**的形式发给 DHCP 服务器。
- 服务器端收到该包以后再**向 DHCP 中继代理返回应答**，并由 **DHCP 中继代理将此包广播给 DHCP 客户端** 。

因此，**DHCP 服务器即使不在同一个链路上也可以实现统一分配和管理IP地址。** 

### 4、NAT网络地址转换

NAT网络地址转换**缓解**了IPv4网络地址耗尽的问题。NAT 就是同个公司、家庭、教室内的主机对外部通信时，把**私有 IP 地址转换成公有 IP 地址**。普通的NAT只是IP地址转化，意义不大。

进一步，可以把**IP地址+端口号一起进行转换**。就用一个全球 IP 地址就可以了，这种转换技术就叫**网络地址与端口转换 NAPT。** 

> <img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/39.jpg" alt="NAPT" style="zoom:50%;" />
>
> 图中有两个客户端 192.168.1.10 和 192.168.1.11 同时与服务器 183.232.231.172 进行通信，并且这两个客户端的本地端口都是 1025。此时，**两个私有 IP 地址都转换 IP 地址为公有地址 120.229.175.121，但是以不同的端口号作为区分。**
>

#### 4.1、NAT的缺点

由于 NAT/NAPT 都依赖于自己的转换表，所以：

- **外部无法主动**与 NAT 内部服务器建立连接，因为 NAPT 转换表没有转换记录。
- 转换表的生成与转换操作都会产生**性能开销**。
- 通信过程中，如果 NAT 路由器重启了，**所有的 TCP 连接都将被重置**。

#### 4.2、解决NAT的问题

##### 4.2.1、改用IPv6

用更大的地址直接解决这个问题。但是IPv6尚未完全普及。

##### 4.2.2、NAT穿透技术

**应用程序主动**发现自己位于NAT设备，主动地获取公有IP，主动在NAT转换表中生成映射。不需要NAT设备来进行转换。

### 5、ICMP控制报文协议

 ICMP 全称是 **Internet Control Message Protocol**，也就是**互联网控制报文协议**。 在网络包遇到问题时反馈信息。

#### 5.1、ICMP功能

 `ICMP` 主要的功能包括：**确认 IP 包是否成功送达目标地址、报告发送过程中 IP 包被废弃的原因和改善网络设置等。** 在 `IP` 通信中如果某个 `IP` 包因为某种原因未能达到目标地址，那么这个具体的原因将**由 ICMP 负责通知**。

> <img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/40.jpg" alt="ICMP 目标不可达消息" style="zoom:50%;" />
>
> 如上图例子，主机 `A` 向主机 `B` 发送了数据包，由于某种原因，途中的路由器 `2` 未能发现主机 `B` 的存在，这时，路由器 `2` 就会向主机 `A` 发送一个 `ICMP` 目标不可达数据包，说明发往主机 `B` 的包未能成功。

ICMP 的这种通知消息会**使用 `IP` 进行发送** 。

#### 5.2、ICMP类型

ICMP 大致可以分为两大类：

- 一类是用于诊断的查询消息，也就是「**查询报文类型**」
- 另一类是通知出错原因的错误消息，也就是「**差错报文类型**」

### 6、IGMP因特网组管理协议

IGMP在组播中管理主机是否在一组中。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/42.jpg" alt="组播模型" style="zoom:50%;" />

**IGMP 是因特网组管理协议，工作在主机（组播成员）和最后一跳路由之间**，如上图中的蓝色部分。

- IGMP 报文**向路由器申请加入和退出组播组**，默认情况下路由器是不会转发组播包到连接中的主机，除非主机通过 IGMP 加入到组播组，主机申请加入到组播组时，路由器就会记录 IGMP 路由器表，路由器后续就会转发组播包到对应的主机了。

#### 6.1、常规查询与响应工作机制 - 维持组播组关系

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/43.jpg" alt=" IGMP 常规查询与响应工作机制" style="zoom:50%;" />

1. 路由器会周期性发送目的地址为 `224.0.0.1`（表示同一网段内所有主机和路由器） **IGMP 常规查询报文**。
2. 主机1 和 主机 3 收到这个查询，随后会启动「报告延迟计时器」，计时器的时间是随机的，通常是 0~10 秒，计时器超时后主机就会发送 **IGMP 成员关系报告报文**（源 IP 地址为自己主机的 IP 地址，目的 IP 地址为组播地址）。如果在定时器超时之前，收到同一个组内的其他主机发送的成员关系报告报文，则自己不再发送，这样可以**减少网络中多余的 IGMP 报文数量**。
3. 路由器收到主机的成员关系报文后，就会在 **IGMP 路由表中加入该组播组**，后续网络中一旦该组播地址的数据到达路由器，它会把数据包转发出去。

#### 6.2、离开组播组工作机制 - 退出组播组

1. 主机 1 要离开组 224.1.1.1，发送 **IGMP离组报文**，报文的目的地址是 224.0.0.2（表示发向网段内的所有路由器）

2. 路由器 收到该报文后，以 1 秒为间隔连续发送 **IGMP 特定组查询报文**（共计发送 2 个），以便确认该网络是否还有 224.1.1.1 组的其他成员。

3. 按照组播组是否存在分为两种情况：

   - 如果该组已经没有主机了，没有主机响应这个查询：一定时间后，路由器认为该网段中**已经没有** 224.1.1.1 组播组成员了，将**不会再向这个网段转发该组播地址的数据包**。

   - 如果该组还有主机：主机 3 仍然是组 224.1.1.1 的成员，因此它**立即响应**这个特定组查询。路由器知道该网络中**仍然存在该组播组的成员，于是继续向该网络转发** 224.1.1.1 的组播数据包。

## 三、ping的工作原理

### 1、ping的助手-ICMP

ICMP **互联网控制报文协议** 用于在网络出问题时报告问题。`ICMP` 主要的功能包括：**确认 IP 包是否成功送达目标地址、报告发送过程中 IP 包被废弃的原因和改善网络设置等。**

在 `IP` 通信中如果某个 `IP` 包因为某种原因未能达到目标地址，那么这个具体的原因将**由 ICMP 负责通知**。

### 2、ICMP报头格式

ICMP 报文是封装在 IP 包里面，它工作在网络层，是 IP 协议的助手。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/5.jpg" alt="ICMP 报文" style="zoom:50%;" />

ICMP 包头的**类型**字段，大致可以分为两大类：

- 一类是用于诊断的查询消息，也就是「**查询报文类型**」
- 另一类是通知出错原因的错误消息，也就是「**差错报文类型**」

### 3、查询报文类型-回送消息

**回送消息**用于进行通信的主机或路由器之间，判断所发送的数据包**是否已经成功到达对端**的一种消息，`ping` 命令就是利用这个消息实现的。

可以向对端主机发送**回送请求**的消息（`ICMP Echo Request Message`，类型 `8`），也可以接收对端主机发回来的**回送应答**消息（`ICMP Echo Reply Message`，类型 `0`）。

![ICMP 回送请求和回送应答报文](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/8.jpg)

相比原生的 ICMP，这里多了两个字段：

- **标识符**：用以区分是哪个应用程序发 ICMP 包，比如用进程 `PID` 作为标识符；
- **序号**：序列号从 `0` 开始，每发送一次新的回送请求就会加 `1`， 可以用来确认网络包是否有丢失。

在**选项数据**中，`ping` 还会存放发送请求的时间值，来计算往返时间，说明路程的长短。

### 4、差错报文信息

#### 4.1、目标不可达消息 ——类型 为 `3`

IP 路由器无法将 IP 数据包发送给目标地址时，会给发送端主机返回一个**目标不可达**的 ICMP 消息，并在这个消息中显示**不可达的具体原因**，原因记录在 ICMP 包头的**代码**字段。

6 种常见的目标不可达类型的**代码**：

- 网络不可达代码为 `0`，没有目标网络，网络不再分类后，这种不可达就很少。

- 主机不可达代码为 `1`，找到了网络，但是没有目标主机。

- 协议不可达代码为 `2`，找到主机后，发现对方有防火墙限制。不接受TCP协议。

- 端口不可达代码为 `3`，可以接收协议，但是目标端口对方服务器不监听。

- 需要进行分片但设置了不分片位代码为 `4`，发送端主机发送 IP 数据报时，将 IP 首部的**分片禁止标志位**设置为`1`。根据这个标志位，途中的路由器遇到超过 MTU 大小的数据包时，不会进行分片，而是直接抛弃。


#### 4.2、原点抑制消息—— 类型 `4`

当路由器向低速线路发送数据时，其发送队列的缓存变为零而无法发送出去时，可以向 IP 包的源地址发送一个 ICMP **原点抑制消息**。收到这个消息的主机借此了解在整个线路的某一处发生了拥堵的情况，从而增大 IP 包的传输间隔，减少网络拥堵的情况。

然而，由于这种 ICMP 可能会引起不公平的网络通信，一般不被使用。

#### 4.3、重定向消息—— 类型 `5`

如果路由器发现发送端主机使用了「不是最优」的路径发送数据，那么它会返回一个 ICMP **重定向消息**给这个主机。在这个消息中包含了**最合适的路由信息和源数据**。这主要发生在路由器持有更好的路由信息的情况下。路由器会通过这样的 ICMP 消息告知发送端，让它下次发给另外一个路由器。

#### 4.4、超时消息—— 类型 `11`

IP 包中有一个字段叫做 `TTL` （`Time To Live`，生存周期），它的**值随着每经过一次路由器就会减 1，直到减到 0 时该 IP 包会被丢弃。**此时，路由器将会发送一个 ICMP **超时消息**给发送端主机，并通知该包已被丢弃，避免在网路中无休止的转发。

### 5、ping的发送和接收 - 使用查询报文

#### 5.1、发送

1. 源主机首先会构建一个 **ICMP 回送请求消息**数据包。
2. ICMP 协议将这个数据包连同**目标地址**一起交给 IP 层。IP 层将以本机 IP 地址作为**源地址**，**协议**字段设置为 `1` 表示是 `ICMP` 协议，再加上一些其他控制信息，构建一个 **`IP` 数据包**。
3. 接下来，需要加入 `MAC` 头。如果在本地 ARP 映射表中查找出 IP 地址 192.168.1.2 所对应的 **MAC 地址**，则可以直接使用；如果没有，则需要发送 `ARP` 协议查询 MAC 地址。
4. 由数据链路层构建一个数据帧，目的地址是 IP 层传过来的 MAC 地址，源地址则是本机的 MAC 地址；还要附加上一些控制信息，依据以太网的介质访问规则，将它们传送出去。

#### 5.2、接收

1. 主机 `B` 收到这个数据帧后，先**检查它的目的 MAC 地址**，并和本机的 MAC 地址对比，如符合，则接收，否则就丢弃。
2. 将 IP 数据包从帧中提取出来，交给本机的 IP 层。同样，IP 层检查后，将有用的信息提取后交给 ICMP 协议。
3. 主机 `B` 会构建一个 **ICMP 回送响应消息**数据包，再发送出去给主机 A。

在规定的时候间内，源主机如果没有接到 ICMP 的应答包，则说明**目标主机不可达**；如果接收到了 ICMP 回送响应消息，则说明**目标主机可达**。

源主机会检查，用当前时刻减去该数据包最初从源主机上发出的时刻，就是 **ICMP 数据包的时间延迟**。

### 6、traceroute - 使用差错报文

#### 6.1、traceroute 作用一：追踪沿途路由器

traceroute 的第一个作用就是**故意设置特殊的 TTL，来追踪去往目的地时沿途经过的路由器。**traceroute 的参数指向某个**目的 IP 地址**。

##### 6.1.1、工作原理：设置递增的TTL

IP 包的**生存期限** 从 `1` 开始按照顺序递增的同时发送 **UDP 包**，强制接收 **ICMP 超时消息**。

比如，将 TTL 设置 为 `1`，则遇到第一个路由器，就牺牲了，接着返回 **ICMP 差错报文**网络包，类型是**时间超时**。接下来将 TTL 设置为 `2`，第一个路由器过了，遇到第二个路由器也牺牲了，也同时返回了 ICMP 差错报文数据包，如此往复，**直到到达目的主机。**

##### 6.1.2、如何直到到达目的主机

发送UDP包时，选择一个不可能的端口号作为目标。如果到了目标主机，返回的报文就不是超时报文，而是**端口不可达报文。**

#### 6.2、traceroute 作用二：**路径MTU发现**

有的时候我们并不知道路由器的 `MTU` 大小，以太网的数据链路上的 `MTU` 通常是 `1500` 字节，但是非以太网的 `MTU` 值就不一样了，所以我们要知道 `MTU` 的大小，从而控制发送的包大小。

##### 6.2.1、工作原理：禁止分片，不断尝试

在发送端主机发送 `IP` 数据报时，将 `IP` 包首部的**分片禁止标志位设置为 1**。根据这个标志位，途中的路由器不会对大数据包进行分片，而是将包丢弃。随后，通过一个 ICMP 的不可达消息将**数据链路上 MTU 的值**一起给发送主机，不可达消息的类型为「**需要进行分片但设置了不分片位**」。

发送主机端每次收到 ICMP 差错报文时就**减少**包的大小，以此来定位一个合适的 `MTU` 值，以便能到达目标主机。

### 7、断网了还能ping吗？

还能ping127.0.0.1、localhost。

#### 7.1、127.0.0.1 

**127 开头的都属于回环地址**，是 `IPV4` 的特殊地址。

#### 7.2、TCP发包和ping

ping和其他应用层软件都属于**应用层**。

正常TCP发包流程：创建Socket；进入传输层带上TCP头；网络层带上IP头；数据链路层带上MAC头；进入网卡的**发送队列 ring buffer** ，顺着网卡就发出去了。ping的流程和TCP包基本是一样的，ping会自己组建一个ICMP的数据包，把正常数据走的路走一遍。

#### 7.3、断网了还能ping127.0.0.1

到了网络层，系统会根据目的IP，在路由表中获取对应的**路由信息**，而这其中就包含选择**哪个网卡**把消息发出。

- 当发现**目标IP是外网IP**时，会从"真网卡"发出。


- 当发现**目标IP是回环地址**时，就会选择**本地网卡**。没有`ring buffer`，会把数据推到一个叫 `input_pkt_queue` 的链表中。这个链表，其实是所有网卡共享的，上面挂着发给本机的各种消息。

  消息被发送到这个链表后，会再触发一个**软中断**。专门处理软中断的内核线程**"ksoftirqd"** ，它在收到软中断后就会立马去链表里把消息取出，然后顺着数据链路层、网络层等层层往上传递最后给到应用程序。

ping 回环地址和**通过TCP等各种协议发送数据到回环地址**都是走这条路径。整条路径从发到收，都没有经过"真网卡"。所以断网了还能ping通127.0.0.1。

#### 7.4、断网ping本机地址

ping 本机IP 跟 ping 回环地址一样，都是走的**本地网卡**。**localhost 是一个域名，默认会被解析为127.0.0.1**。默认情况下，使用 `localhost` 跟使用 `127.0.0.1` 是没区别的。

#### 7.5、0.0.0.0网络地址

0.0.0.0的功能需要区分**连接、监听**两个场景。

**连接**：在`IPV4`中，0.0.0.0表示的是无效的**目标地址**。执行 ping 0.0.0.0 ，是会失败的。 客户端 `connect` 时，不能使用 `0.0.0.0` 。必须指明要连接哪个服务器IP。

**监听**：启动服务器的时候，一般会 `listen` 一个 IP 和端口，等待客户端的连接。此时 `listen` 的是本机的 `0.0.0.0` , 那么它表示本机上的**所有IPV4地址**。如果服务器 `listen` 的是 `0.0.0.0`，那么此时用`127.0.0.1`和本机地址**都可以**访问到服务。
